FROM ruby:2.2.3

ENV LANG=C.UTF-8
ENV TZ=Asia/Tokyo

ARG RAILS_ENV=production
ENV RAILS_ENV=${RAILS_ENV}
ENV RACK_ENV=${RAILS_ENV}

ARG RAILS_LOG_TO_STDOUT=true
ENV RAILS_LOG_TO_STDOUT=${RAILS_LOG_TO_STDOUT}

ARG RAILS_SERVE_STATIC_FILES=true
ENV RAILS_SERVE_STATIC_FILES=${RAILS_SERVE_STATIC_FILES}

ARG MYSQL_HOST=db
ENV MYSQL_HOST=${MYSQL_HOST}

ARG MYSQL_USER
ENV MYSQL_USER=${MYSQL_USER}

ARG MYSQL_PASSWORD
ENV MYSQL_PASSWORD=${MYSQL_PASSWORD}

ARG MYSQL_SOCKET
ENV MYSQL_SOCKET=${MYSQL_SOCKET}

ARG RV_GOOGLE_API_CLIENT_ID='********.apps.googleusercontent.com'
ARG RV_GOOGLE_API_SECRET='********'
ARG RV_RENDEZVOUS_APP_HOST='https://rendezvous.zigexn.co.jp'
ARG RV_S3_ASSESS_KEY_ID='********'
ARG RV_S3_BACKET_NAME='********'
ARG RV_S3_SECRET_ACCESS_KEY='********'
ARG SECRET_KEY_BASE='********'

ENV DATABASE_URL='mysql2://URI'
ENV NEW_RELIC_LICENSE_KEY='NEW_RELIC_LICENSE_KEY'
ENV NEW_RELIC_LOG='stdout'
ENV RV_ALLOW_IPS='121.3.148.224,121.2.76.17,121.2.76.22,118.69.34.46,122.212.32.178,14.161.45.187,124.219.164.151,118.241.144.209,153.142.84.195,39.110.206.184,68.38.21.53,223.134.8.107,36.3.241.231,210.168.56.111,203.183.96.131'
ENV RV_GOOGLE_ANALYTICS_ID='UA-21255105-22'
ENV RV_GOOGLE_API_CLIENT_ID=${RV_GOOGLE_API_CLIENT_ID}
ENV RV_GOOGLE_API_SECRET=${RV_GOOGLE_API_SECRET}
ENV RV_HIPCHAT_ROOM='Rendezvous%E6%96%B0%E7%9D%80%E9%80%9A%E7%9F%A5'
ENV RV_HIPCHAT_TOKEN='443500a97263cb688d35dc66593927'
ENV RV_NEWRELIC_LICENSE_KEY='NEWRELIC_LICENSE_KEY'
ENV RV_PDF_UPLOADING=1
ENV RV_PERMITTED_LOGIN_DOMAIN='zigexn.co.jp,zigexn.vn,mybrainlab.net'
ENV RV_RENDEZVOUS_APP_HOST=${RV_RENDEZVOUS_APP_HOST}
ENV RV_S3_ASSESS_KEY_ID=${RV_S3_ASSESS_KEY_ID}
ENV RV_S3_BACKET_NAME=${RV_S3_BACKET_NAME}
ENV RV_S3_SECRET_ACCESS_KEY=${RV_S3_SECRET_ACCESS_KEY}
ENV SECRET_KEY_BASE=${SECRET_KEY_BASE}
ENV WEB_CONCURRENCY=2

RUN apt-get -y clean && apt-get update -qq && apt-get -y install nodejs libv8-dev --force-yes

WORKDIR /myapp
COPY . /myapp

RUN bundle install -j4

# Add a script to be executed every time the container starts.
COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh
ENTRYPOINT ["entrypoint.sh"]
EXPOSE 8080

# Configure the main process to run when running the image
CMD ["rails", "server", "-p", "8080", "-b", "0.0.0.0"]
