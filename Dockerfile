#FROM ruby:2.2.3
FROM ruby:2.3

ENV LANG=C.UTF-8
ENV TZ=Asia/Tokyo

ARG RAILS_ENV=production
ENV RAILS_ENV=${RAILS_ENV}
ENV RACK_ENV=${RAILS_ENV}

ARG RAILS_LOG_TO_STDOUT=true
ENV RAILS_LOG_TO_STDOUT=${RAILS_LOG_TO_STDOUT}

ARG RAILS_SERVE_STATIC_FILES=true
ENV RAILS_SERVE_STATIC_FILES=${RAILS_SERVE_STATIC_FILES}

ARG MYSQL_HOST=db
ENV MYSQL_HOST=${MYSQL_HOST}

ARG MYSQL_USER=root
ENV MYSQL_USER=${MYSQL_USER}

ARG MYSQL_PASSWORD=''
ENV MYSQL_PASSWORD=${MYSQL_PASSWORD}

ARG MYSQL_SOCKET
ENV MYSQL_SOCKET=${MYSQL_SOCKET}

ENV DATABASE_URL='mysql2://b74855868df2c4:41c4c9d8@us-cdbr-iron-east-01.cleardb.net/heroku_346ef209e25ee2c?reconnect=true'
ENV NEW_RELIC_LICENSE_KEY='e2caa1425d2a8301f0f204141639c51d59639944'
ENV NEW_RELIC_LOG='stdout'
ENV RV_ALLOW_IPS='121.3.148.224,121.2.76.17,121.2.76.22,118.69.34.46,122.212.32.178,14.161.45.187,124.219.164.151,118.241.144.209,153.142.84.195,39.110.206.184,68.38.21.53,223.134.8.107,36.3.241.231,210.168.56.111,203.183.96.131'
ENV RV_GOOGLE_ANALYTICS_ID='UA-21255105-22'
ENV RV_GOOGLE_API_CLIENT_ID='166042553071-itedsqqtud6o14gvdtp6j48hnaltdrdi.apps.googleusercontent.com'
ENV RV_GOOGLE_API_SECRET='NkW8mcxBO9u3MC-6N2j16fco'
ENV RV_HIPCHAT_ROOM='Rendezvous%E6%96%B0%E7%9D%80%E9%80%9A%E7%9F%A5'
ENV RV_HIPCHAT_TOKEN='443500a97263cb688d35dc66593927'
ENV RV_NEWRELIC_LICENSE_KEY='7bd008493661cbb36f85d52068addbe8ffecaf04'
ENV RV_PDF_UPLOADING=1
ENV RV_PERMITTED_LOGIN_DOMAIN='zigexn.co.jp,zigexn.vn,mybrainlab.net'
#ENV RV_RENDEZVOUS_APP_HOST='http://rendezvous-zigexn.herokuapp.com'
ENV RV_RENDEZVOUS_APP_HOST='https://rendezvous.zigexn.co.jp'
ENV RV_S3_ASSESS_KEY_ID='AKIAIW6PSL3NE2XJ2RBA'
ENV RV_S3_BACKET_NAME='rendezvous-uploads'
ENV RV_S3_SECRET_ACCESS_KEY='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'
ENV SECRET_KEY_BASE='f3f3d5ffad60c951050eac21c4bae09555e1c20a3d9f399aa7b4fc6fd7dae811eac462e9c814ca175a4b80b71094c6b1002d1bca6e226b0947edfad395c0053d'
ENV WEB_CONCURRENCY=2

RUN apt-get -y clean && apt-get update -qq
RUN apt-get -y install nodejs libv8-dev --force-yes

WORKDIR /myapp
COPY . /myapp

RUN bundle install -j4

# Add a script to be executed every time the container starts.
COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh
ENTRYPOINT ["entrypoint.sh"]
EXPOSE 8080

# Configure the main process to run when running the image
CMD ["rails", "server", "-p", "8080", "-b", "0.0.0.0"]
